<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Edward’s Growth Timeline</title>
<meta name="description" content="Public timeline built from Markdown. Tick items as Done, filter/search, and publish on GitHub Pages.">
<style>
  :root{--bg:#0b0f14;--card:#101725;--muted:#8aa0b4;--text:#e6eef6;--accent:#4fd1c5;--line:#2a3b52;--dot:#7dd3fc;--done:#93c5fd;}
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .container{max-width:1100px;margin:0 auto;padding:24px}
  header{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .title{font-size:28px;font-weight:800}
  .subtitle{color:var(--muted);font-size:13px}
  .controls{display:flex;gap:10px;flex-wrap:wrap}
  .control{background:var(--card);border:1px solid #1f2b3a;color:var(--text);padding:10px 12px;border-radius:12px;min-width:160px}
  .control input{width:100%;background:transparent;border:none;color:inherit;outline:none}
  .pill{padding:8px 12px;border-radius:999px;border:1px solid #223146;background:transparent;color:var(--muted);cursor:pointer}
  .pill.active{border-color:var(--accent);color:var(--accent);background:rgba(79,209,197,0.1)}
  .timeline{position:relative;margin:26px 0 60px 0;padding-left:26px}
  .timeline::before{content:"";position:absolute;left:16px;top:0;bottom:0;width:2px;background:linear-gradient(to bottom, transparent, var(--line) 10%, var(--line) 90%, transparent)}
  .item{position:relative;margin:22px 0 22px 6px}
  .dot{position:absolute;left:-4px;top:10px;width:18px;height:18px;border-radius:50%;background:radial-gradient(circle at 30% 30%, white, var(--dot) 35%, #134e6f);border:2px solid #1f2b3a;box-shadow:0 0 0 4px rgba(125,211,252,0.15)}
  .card{background:linear-gradient(180deg, rgba(23,33,49,0.9), rgba(14,20,31,0.9));border:1px solid #1f2b3a;border-radius:16px;padding:16px 18px 14px 18px;box-shadow:0 8px 24px rgba(0,0,0,0.35);transition:transform .2s, box-shadow .2s, border-color .2s}
  .card:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(0,0,0,0.4);border-color:#2b3f58}
  .meta{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px;margin-bottom:6px;flex-wrap:wrap}
  .badge{border:1px solid #223146;border-radius:8px;padding:4px 8px}
  .heading{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  .heading h3{margin:6px 0 8px 0;font-size:18px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  button.btn{border:1px solid #223146;background:#0d1422;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font-size:13px}
  button.btn:hover{border-color:#2b3f58}
  .done .card{opacity:.88;filter:saturate(.7)}
  .done .heading h3{text-decoration:line-through;color:var(--done)}
  .content{line-height:1.6}
  .content s, .content del{text-decoration:line-through}
  .empty{padding:24px;border:1px dashed #2b3f58;border-radius:12px;color:var(--muted);text-align:center;margin:18px 0}
  .legend{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px;margin-top:6px}
  .legend .swatch{display:inline-block;width:10px;height:10px;border-radius:2px;margin-right:6px}
  .swatch.level{background:linear-gradient(45deg,#22d3ee,#4f46e5)}
  .swatch.chapter{background:linear-gradient(45deg,#34d399,#10b981)}
  .drop{margin-top:14px;border:1px dashed #384b66;border-radius:12px;padding:14px;color:var(--muted);display:none}
  .drop strong{color:var(--text)}
  .hint{font-size:12px;color:#a7b8cb;margin-top:6px}
  @media (max-width:640px){.timeline{padding-left:20px}.timeline::before{left:12px}.item{margin-left:2px}}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <div class="title">Edward’s Growth Timeline</div>
      <div class="subtitle">Đọc từ <code>plan.md</code> • Tick “Done” để gạch • Search/Filter • Public GitHub Pages</div>
      <div class="legend"><span class="swatch level"></span> Level &nbsp;&nbsp; <span class="swatch chapter"></span> Chapter</div>
    </div>
    <div class="controls">
      <div class="control"><input id="search" type="search" placeholder="Tìm Level/Chapter..."></div>
      <button class="pill active" data-filter="all">All</button>
      <button class="pill" data-filter="undone">Undone</button>
      <button class="pill" data-filter="done">Done</button>
    </div>
  </header>

  <div id="dropZone" class="drop">
    <strong>Không đọc được plan.md?</strong> Kéo-thả file <code>plan.md</code> vào đây hoặc <input type="file" id="filepick" accept=".md" /> để tải nội dung. <div class="hint">Một số trình duyệt chặn <code>fetch()</code> khi mở bằng <code>file://</code>. GitHub Pages sẽ tải bình thường.</div>
  </div>

  <div id="timeline" class="timeline"></div>
  <div class="empty" id="empty" style="display:none">Không có mục nào khớp bộ lọc/tìm kiếm.</div>
</div>

<script>
// ---- Tiny Markdown -> HTML ----
function mdToHtml(md) {
  const lines = md.replace(/\r\n/g,'\n').split('\n');
  let html = '', inList = false;
  function closeList(){ if(inList){ html += '</ul>'; inList=false; } }
  for (let raw of lines) {
    const line = raw.trimRight();
    if (/^###\s+/.test(line)) { closeList(); html += `<h2>${escapeHtml(line.replace(/^###\s+/,'').trim())}</h2>`; continue; }
    if (/^####\s+/.test(line)) { closeList(); html += `<h3>${escapeHtml(line.replace(/^####\s+/,'').trim())}</h3>`; continue; }
    if (/^\*\*\*+$/.test(line)) { closeList(); html += '<hr/>'; continue; }
    if (/^\*\s+/.test(line) || /^-\s+/.test(line)) {
      if (!inList) { html += '<ul>'; inList = true; }
      const t = line.replace(/^\*\s+|^-\s+/, '');
      html += `<li>${inline(t)}</li>`;
      continue;
    }
    if (line === '') { closeList(); html += ''; continue; }
    closeList();
    html += `<p>${inline(line)}</p>`;
  }
  closeList();
  return html;

  function inline(t){
    t = t.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    t = t.replace(/(^|[^\*])\*(?!\s)(.+?)\*(?!\w)/g, '$1<em>$2</em>');
    t = t.replace(/~~(.+?)~~/g, '<s>$1</s>');
    return linkify(escapeHtmlExceptBasic(t));
  }
  function escapeHtml(s){ return s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
  function escapeHtmlExceptBasic(s){
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/&lt;(strong|em|s)&gt;/g,'<$1>').replace(/&lt;\/(strong|em|s)&gt;/g,'</$1>');
  }
  function linkify(text){
    return text.replace(/(https?:\/\/[^\s)]+)|(\b[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}\b)/gi, function(m){
      if (m.indexOf('http')===0){ return `<a href="${m}" target="_blank" rel="noopener">${m}</a>`; }
      return `<a href="mailto:${m}">${m}</a>`;
    });
  }
}

// ---- Parse Levels/Chapters ----
function slug(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function parsePlan(md) {
  const lines = md.split('\n');
  const items = [];
  let currentLevel = null;
  let currentChapter = null;
  let buffer = [];

  function pushChapter() {
    if (!currentChapter) return;
    const content = buffer.join('\n').trim();
    const id = slug((currentLevel?.title || '') + '-' + currentChapter.title);
    items.push({
      level: currentLevel?.title || 'Unknown Level',
      title: currentChapter.title,
      date: currentChapter.date || '',
      key: id,
      md: content
    });
    buffer = [];
  }

  for (const raw of lines) {
    const line = raw.trimEnd();
    const mLevel = /^###\s+(.+)$/.exec(line);
    if (mLevel) { pushChapter(); currentLevel = { title: mLevel[1].trim() }; currentChapter = null; buffer = []; continue; }
    const mChap = /^####\s+Chapter\s+\d+\s*\(([^)]+)\):\s*(.+)$/.exec(line);
    if (mChap) { pushChapter(); currentChapter = { date: mChap[1], title: mChap[2].trim() }; buffer = []; continue; }
    buffer.push(line);
  }
  pushChapter();
  if (items.length===0){ items.push({level:'Plan', title:'Full Plan', date:'', key:'full-plan', md: md}); }
  return items;
}

// ---- State & Render ----
const LS_KEY = 'edward_timeline_done_planmd';
function loadDone(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); }catch{return{}}}
function saveDone(m){ try{ localStorage.setItem(LS_KEY, JSON.stringify(m)); }catch{} }

let doneMap = loadDone();
let filter = 'all';
let query = '';
const timelineEl = document.getElementById('timeline');
const emptyEl = document.getElementById('empty');

function renderFromMarkdown(md){
  const allItems = parsePlan(md);
  timelineEl.innerHTML = '';
  const q = query.trim().toLowerCase();
  let count = 0;
  for (const it of allItems){
    const isDone = !!doneMap[it.key];
    if (filter === 'done' && !isDone) continue;
    if (filter === 'undone' && isDone) continue;
    const text = (it.title + ' ' + it.level + ' ' + it.date).toLowerCase();
    if (q && !text.includes(q)) continue;

    const item = document.createElement('div');
    item.className = 'item' + (isDone ? ' done' : '');

    const dot = document.createElement('div'); dot.className = 'dot'; item.appendChild(dot);

    const card = document.createElement('div'); card.className = 'card';

    const meta = document.createElement('div'); meta.className = 'meta';
    const b1 = document.createElement('span'); b1.className = 'badge'; b1.textContent = it.level; meta.appendChild(b1);
    if (it.date){ const b2 = document.createElement('span'); b2.className = 'badge'; b2.textContent = it.date; meta.appendChild(b2); }
    card.appendChild(meta);

    const head = document.createElement('div'); head.className = 'heading';
    const h3 = document.createElement('h3'); h3.textContent = it.title; head.appendChild(h3);

    const actions = document.createElement('div'); actions.className = 'actions';
    const btn = document.createElement('button'); btn.className = 'btn'; btn.textContent = isDone ? 'Mark as Undone' : 'Mark as Done';
    btn.addEventListener('click', ()=>{ doneMap[it.key] = !doneMap[it.key]; saveDone(doneMap); renderFromMarkdown(md); });
    const jump = document.createElement('a'); jump.className = 'btn'; jump.href = '#'+it.key; jump.textContent = 'Jump';
    jump.addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById(it.key)?.scrollIntoView({behavior:'smooth', block:'center'}); });
    actions.appendChild(btn); actions.appendChild(jump);
    head.appendChild(actions);
    card.appendChild(head);

    const content = document.createElement('div'); content.className = 'content'; content.id = it.key; content.innerHTML = mdToHtml(it.md);
    card.appendChild(content);

    item.appendChild(card);
    timelineEl.appendChild(item);
    count++;
  }
  emptyEl.style.display = count === 0 ? '' : 'none';
}

document.getElementById('search').addEventListener('input', (e)=>{ query = e.target.value; if(window.__md) renderFromMarkdown(window.__md); });
document.querySelectorAll('.pill').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.pill').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    filter = btn.getAttribute('data-filter');
    if(window.__md) renderFromMarkdown(window.__md);
  });
});

// ---- Load plan.md with fetch, fallback to drop zone ----
async function loadMarkdown(){
  const drop = document.getElementById('dropZone');
  try{
    const res = await fetch('plan.md', {cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const md = await res.text();
    window.__md = md;
    renderFromMarkdown(md);
  }catch(err){
    drop.style.display = 'block'; // show fallback
  }
}
loadMarkdown();

// Fallback: drag-drop or file picker
const drop = document.getElementById('dropZone');
const picker = document.getElementById('filepick');
['dragenter','dragover'].forEach(evt => drop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); drop.style.borderColor='#4fd1c5'; }));
['dragleave','drop'].forEach(evt => drop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); drop.style.borderColor='#384b66'; }));
drop.addEventListener('drop', e=>{
  const f = e.dataTransfer.files[0];
  if (f) readFile(f);
});
picker.addEventListener('change', e=>{
  const f = e.target.files[0];
  if (f) readFile(f);
});
function readFile(file){
  const reader = new FileReader();
  reader.onload = e => { window.__md = String(e.target.result || ''); renderFromMarkdown(window.__md); };
  reader.readAsText(file);
}
</script>
</body>
</html>
